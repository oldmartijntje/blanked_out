var it=Object.defineProperty;var nt=(n,t,s)=>t in n?it(n,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[t]=s;var g=(n,t,s)=>(nt(n,typeof t!="symbol"?t+"":t,s),s);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function s(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(r){if(r.ep)return;r.ep=!0;const o=s(r);fetch(r.href,o)}})();const l={baseUrl:"blanked_out",assetsPath:"assets",keys:{upKeys:["ArrowUp","KeyW"],downKeys:["ArrowDown","KeyS"],leftKeys:["ArrowLeft","KeyA"],rightKeys:["ArrowRight","KeyD"]},sizes:{gridSize:64,canvasWidth:1280,canvasHeight:1280}},K="LEFT",Y="RIGHT",W="UP",U="DOWN",rt="Space",N={UP:l.keys.upKeys,DOWN:l.keys.downKeys,LEFT:l.keys.leftKeys,RIGHT:l.keys.rightKeys,SPACE:[rt]},S=[K,Y,W,U];class ot{constructor(){this.heldDirections=[],this.keys={},this.lastKeys={},document.addEventListener("keydown",t=>{this.keys[t.code]=!0,this.getDirection(t.code,!0)}),document.addEventListener("keyup",t=>{this.keys[t.code]=!1,this.getDirection(t.code,!1)}),document.addEventListener("DOMContentLoaded",()=>{for(const t of Object.keys(N))for(const s of N[t]){const i=document.querySelectorAll(`.${s}.gameController`);for(const r of i)r.addEventListener("mousedown",()=>{S.includes(t)&&this.onKeyPressed(t),this.keys[s]=!0}),r.addEventListener("mouseup",()=>{S.includes(t)&&this.onKeyReleased(t),this.keys[s]=!1}),r.addEventListener("touchstart",o=>{o.preventDefault(),S.includes(t)&&this.onKeyPressed(t),this.keys[s]=!0}),r.addEventListener("touchend",o=>{o.preventDefault(),S.includes(t)&&this.onKeyReleased(t),this.keys[s]=!1})}})}get direction(){return this.heldDirections[0]}getDirection(t,s){for(const i of Object.keys(N))N[i].includes(t)&&S.includes(i)&&(s?this.onKeyPressed(i):this.onKeyReleased(i))}update(){this.lastKeys={...this.keys}}getActionJustPressed(t){let s=!1;return this.keys[t]&&!this.lastKeys[t]&&(s=!0),s}onKeyPressed(t){this.heldDirections.includes(t)||this.heldDirections.unshift(t)}onKeyReleased(t){const s=this.heldDirections.indexOf(t);s>-1&&this.heldDirections.splice(s,1)}}class u{constructor(t=0,s=0){this.x=t,this.y=s}duplicate(){return new u(this.x,this.y)}matches(t){return this.x===t.x&&this.y===t.y}toString(){return`Vector2(${this.x}, ${this.y})`}toNeighbor(t){let s=this.x,i=this.y;switch(t){case W:i-=l.sizes.gridSize;break;case U:i+=l.sizes.gridSize;break;case K:s-=l.sizes.gridSize;break;case Y:s+=l.sizes.gridSize;break}if(s==this.x&&i==this.y)throw new Error("Invalid direction "+t+" for "+this.toString());return new u(s,i)}}class at{constructor(t,s){g(this,"mainLoop",t=>{if(!this.isRunning)return;let s=t-this.lastFrameTime;for(this.lastFrameTime=t,this.accumulatedTime+=s;this.accumulatedTime>=this.timeStep;)this.update(this.timeStep),this.accumulatedTime-=this.timeStep;this.render(),this.rafId=requestAnimationFrame(this.mainLoop)});this.lastFrameTime=0,this.accumulatedTime=0,this.timeStep=1e3/60,this.update=t,this.render=s,this.rafId=null,this.isRunning=!1}start(){this.isRunning||(this.isRunning=!0,this.rafId=requestAnimationFrame(this.mainLoop))}stop(){this.rafId||cancelAnimationFrame(this.rafId),this.isRunning=!1}}class ct{constructor(){g(this,"callbacks",[]);g(this,"nextId",0)}emit(t,s){this.callbacks.forEach(i=>{i.eventName===t&&i.callback(s)})}on(t,s,i){return this.nextId++,this.callbacks.push({id:this.nextId,eventName:t,caller:s,callback:i}),this.nextId}off(t){this.callbacks=this.callbacks.filter(s=>s.id!==t)}unsubscribe(t){this.callbacks=this.callbacks.filter(s=>s.caller!==t)}}const E=new ct;class m{}g(m,"PLAYER_PICK_UP_ITEM","PLAYER_PICK_UP_ITEM"),g(m,"CHANGE_SCENE","CHANGE_SCENE"),g(m,"START_TEXT_BOX","START_TEXT_BOX"),g(m,"END_TEXT_BOX","END_TEXT_BOX"),g(m,"CAMERA_POSITION","CAMERA_POSITION"),g(m,"DO_ACTION_ON_COORDINATE","DO_ACTION_ON_COORDINATE");class I{constructor({position:t}){this.position=t??new u(0,0),this.children=[],this.parent=null,this.hasBeenInitiated=!1,this.isSolid=!1,this.drawLayer=null}stepEntry(t,s){this.children.forEach(i=>i.stepEntry(t,s)),this.hasBeenInitiated||(this.hasBeenInitiated=!0,this.onInit()),this.step(t,s)}onInit(){}step(t){}draw(t,s,i){const r=s+this.position.x,o=i+this.position.y;this.drawImage(t,r,o),this.getDrawChildrenOrdered().forEach(a=>a.draw(t,r,o))}getDrawChildrenOrdered(){return[...this.children].sort((t,s)=>s.drawLayer==="FLOOR"||t.position.y>s.position.y?1:-1)}drawImage(t,s,i){}destroy(){this.children.forEach(t=>t.destroy()),this.parent&&this.parent.removeChild(this)}addChild(t){t.parent=this,this.children.push(t)}removeChild(t){E.unsubscribe(t),this.children=this.children.filter(s=>s!==t)}}class ht extends I{constructor(){super({});g(this,"zoom",1);this.zoom=1,this.offset=new u(0,0),this.onInit()}onInit(){E.on(m.CAMERA_POSITION,this,s=>{s.focus&&this.centerPositionOnTarget(s.position)}),E.on(m.CHANGE_SCENE,this,s=>{this.centerPositionOnTarget(s.heroStartPosition)})}centerPositionOnTarget(s){this.position=new u(-s.x+632,-s.y+632)}}class lt{constructor(){this.flags=new Map}add(t){this.flags.set(t,!0)}remove(t){this.flags.delete(t)}getRelevantScenario(t=[]){return t.find(s=>{const i=s.bypass??[];for(let o=0;o<i.length;o++){const a=i[o];if(this.flags.has(a))return!1}const r=s.requires??[];for(let o=0;o<r.length;o++){const a=r[o];if(!this.flags.has(a))return!1}return!0})}}const M=new lt;class dt{constructor(){this.toLoad={hero:"sprites/hero-sheet.png",shadow:"sprites/shadow.png",rod:"sprites/rod.png",exit:"sprites/exit.png",sky:"sprites/sky.png",ground:"sprites/ground.png",cave:"sprites/cave.png",caveGround:"sprites/cave-ground.png",knight:"sprites/knight-sheet-1.png",textBox:"sprites/text-box.png",portraits:"sprites/portraits-sheet.png",fontWhite:"sprites/sprite-font-white.png"},this.images={};var t="";try{t="/"+l.baseUrl+"/"+l.assetsPath+"/"}catch(s){console.log(s),t="/"+l.baseUrl+"/"+l.assetsPath+"/"}console.log(`"${t}"`),Object.keys(this.toLoad).forEach(s=>{const i=new Image;i.src=t+this.toLoad[s],this.images[s]={image:i,isLoaded:!1},i.onload=()=>{this.images[s].isLoaded=!0}})}}const O=new dt;class T extends I{constructor({resource:t,frameSize:s,hFrames:i,vFrames:r,frame:o,scale:a,position:c,animations:y}){super({position:c??new u(0,0)}),this.resource=t,this.frameSize=s??new u(l.sizes.gridSize,l.sizes.gridSize),this.hFrames=i??1,this.vFrames=r??1,this.frame=o??0,this.frameMap=new Map,this.scale=a??1,this.position=c??new u(0,0),this.animations=y??null,this.buildFrameMap()}buildFrameMap(){let t=0;for(let s=0;s<this.vFrames;s++)for(let i=0;i<this.hFrames;i++)this.frameMap.set(t,new u(i*this.frameSize.x,s*this.frameSize.y)),t++}step(t){this.animations&&(this.animations.step(t),this.frame=this.animations.frame)}drawImage(t,s,i){if(!this.resource.isLoaded)return;let r=0,o=0;const a=this.frameMap.get(this.frame);a&&(r=a.x,o=a.y);const c=this.frameSize.x,y=this.frameSize.y;t.drawImage(this.resource.image,r,o,c,y,s,i,c*this.scale,y*this.scale)}}class ut extends I{constructor(){super({position:new u(0,1)}),this.items=[],this.drawLayer="HUD",this.nextId=0,this.renderInventory()}renderInventory(){this.children.forEach(t=>t.destroy()),this.items.forEach((t,s)=>{const i=new T({resource:t.image,position:new u(s*12,0)});this.addChild(i)})}removeFromInventory(t){this.items=this.items.filter(s=>s.id!==t),this.renderInventory()}onInit(){E.on(m.PLAYER_PICK_UP_ITEM,this,t=>{this.items.push({id:this.nextId++,image:t.image}),console.log(this.items),this.renderInventory()})}}const ft=5,d=new Map;d.set("i",2);d.set("j",4);d.set("l",3);d.set("r",4);d.set("t",4);d.set("u",4);d.set("v",4);d.set("x",4);d.set("y",4);d.set("z",4);d.set("E",4);d.set("F",4);d.set("M",7);d.set("W",7);d.set(" ",3);d.set("'",2);d.set("!",1);const mt=n=>d.get(n)??ft,G=new Map;["abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ","0123456789 __",".!-,?'"].join("").split("").forEach((n,t)=>{G.set(n,t)});const pt=n=>G.get(n)??null,gt=4,Et=1,wt=3,yt=20,Tt=1,It=1;class _t extends I{constructor(t={}){super({position:new u(32,108)}),this.drawLayer="HUD";const s=t.string??"Default Text";this.words=s.split(" ").map(i=>{let r=0;const o=i.split("").map(a=>{const c=mt(a);return r+=c,{width:c,sprite:new T({resource:O.images.fontWhite,hFrames:13,vFrames:6,frame:pt(a)})}});return{wordWidth:r,chars:o}}),this.backdrop=new T({resource:O.images.textBox,frameSize:new u(256,64)}),t.portraitFrame!==null&&t.portraitFrame!==void 0?this.portrait=new T({resource:O.images.portraits,hFrames:4,vFrames:1,frame:t.portraitFrame??0}):this.portrait=null,this.showingIndex=0,this.finalIndex=this.words.reduce((i,r)=>i+r.chars.length,0),this.textSpeed=yt,this.timeUntilNextShow=this.textSpeed}step(t,s){const i=s.input;if(i!=null&&i.getActionJustPressed("Space")){if(this.showingIndex<this.finalIndex){this.showingIndex=this.finalIndex;return}E.emit(m.END_TEXT_BOX)}this.timeUntilNextShow-=t,this.timeUntilNextShow<=0&&(this.showingIndex+=It,this.timeUntilNextShow+=this.textSpeed)}drawImage(t,s,i){this.backdrop.drawImage(t,s,i),this.portrait&&this.portrait.drawImage(t,s+6,i+6);const a=7,c=7,y=240,J=14,Z=18,Q=2;let v=a,k=c;this.portrait&&(v+=Z,k+=Q);let D=s+v,b=i+k,X=0;this.words.forEach(z=>{s+y-D<z.wordWidth&&(D=s+v,b+=J),z.chars.forEach(V=>{if(X>this.showingIndex)return;const{sprite:tt,width:et}=V,st=D-gt;tt.draw(t,st,b),D+=et+Et,X+=Tt}),D+=wt})}}class Dt extends I{constructor(){super({}),this.level=null,this.input=new ot,this.camera=new ht}onInit(){const t=new ut;this.addChild(t),E.on(m.CHANGE_SCENE,this,s=>{this.setLevel(s)}),E.on(m.DO_ACTION_ON_COORDINATE,this,s=>{if(typeof s.getContent=="function"){const i=s.getContent();if(!i)return;i.addsFlags&&i.addsFlags.forEach(c=>{M.add(c)}),i.removesFlags&&i.removesFlags.forEach(c=>{M.remove(c)});const r={string:i.string,portraitFrame:i.portraitFrame??null};let o=null;o=new _t(r),this.addChild(o),E.emit(m.START_TEXT_BOX);const a=E.on(m.END_TEXT_BOX,this,()=>{o.destroy(),E.off(a)})}})}setLevel(t){this.level&&this.level.destroy(),this.level=t,this.addChild(this.level)}drawBackground(t){var s;(s=this.level)==null||s.background.drawImage(t,0,0)}drawObjects(t){this.children.forEach(s=>{s.drawLayer!=="HUD"&&s.draw(t,0,0)})}drawForeground(t){this.children.forEach(s=>{s.drawLayer==="HUD"&&s.draw(t,0,0)})}}class St extends I{constructor(){super({}),this.background=null,this.walls=new Set}}class Ot extends St{constructor(t={}){super({}),this.background=new T({resource:O.images.sky,frameSize:new u(l.sizes.canvasWidth,l.sizes.canvasHeight),scale:8});const s=new T({resource:O.images.ground,frameSize:new u(l.sizes.canvasWidth,l.sizes.canvasHeight),scale:4});this.addChild(s)}onInit(){}}const f=document.querySelector("#game-canvas"),w=f.getContext("2d"),h=new Dt({position:new u(0,0)});h.setLevel(new Ot);let p=1;const H=.05;let _=!1,R=0,F=0,L=0,P=0,x=0,A=!1;const B=.5,q=3;let C;const xt=n=>{var t;h.stepEntry(n,h),(t=h.input)==null||t.update()},j=n=>{const t=f.getBoundingClientRect(),s=((n.clientX||n.touches[0].clientX)-t.left-L)/p,i=((n.clientY||n.touches[0].clientY)-t.top-P)/p;console.log("Clicked at",s,i)},At=()=>{w.clearRect(0,0,f.width,f.height),h.drawBackground(w),w.save(),h.camera&&(w.translate(f.width/2,f.height/2),w.scale(p,p),w.translate(-f.width/2+h.camera.position.x,-f.height/2+h.camera.position.y)),h.drawObjects(w,0,0),w.restore(),h.drawForeground(w)},Nt=new at(xt,At);Nt.start();const Lt=n=>{_=!0,L=n.clientX||n.touches[0].clientX,P=n.clientY||n.touches[0].clientY,C=new Date().getTime()},Pt=n=>{if(_){const t=n.clientX||n.touches[0].clientX,s=n.clientY||n.touches[0].clientY,i=(n.touches,1);h.camera.position.x+=(t-L)*i/p,h.camera.position.y+=(s-P)*i/p,L=t,P=s}},$=n=>{_=!1,new Date().getTime()-C<200&&!A&&j(n)},Ct=n=>{n.preventDefault();const t=n.deltaY<0?1+H:1-H;p*=t,p=Math.max(B,Math.min(q,p))},vt=n=>{if(n.touches.length===2){n.preventDefault();const t=n.touches[0],s=n.touches[1];x=Math.hypot(s.clientX-t.clientX,s.clientY-t.clientY)}else e.touches.length===1&&(_=!0,R=n.touches[0].clientX,F=n.touches[0].clientY,C=new Date().getTime())},Rt=n=>{if(A){n.preventDefault();return}if(n.touches.length===2){n.preventDefault();const t=n.touches[0],s=n.touches[1],i=Math.hypot(s.clientX-t.clientX,s.clientY-t.clientY);if(x>0){const r=i/x,o=p*r;if(o>=B&&o<=q){p=o;const a=(t.clientX+s.clientX)/2,c=(t.clientY+s.clientY)/2;h.camera.position.x=a-(a-h.camera.position.x)*r,h.camera.position.y=c-(c-h.camera.position.y)*r}else A=!0}x=i}else if(n.touches.length===1&&_){const t=n.touches[0].clientX,s=n.touches[0].clientY;h.camera.position.x+=(t-R)/p,h.camera.position.y+=(s-F)/p,R=t,F=s}},Ft=n=>{n.touches.length<2&&(x=0,A=!1),new Date().getTime()-C<200&&!A&&j(n),_=!1};f.addEventListener("mousedown",Lt);f.addEventListener("mousemove",Pt);f.addEventListener("mouseup",$);f.addEventListener("mouseleave",$);f.addEventListener("wheel",Ct,{passive:!1});f.addEventListener("touchstart",vt,{passive:!1});f.addEventListener("touchmove",Rt,{passive:!1});f.addEventListener("touchend",Ft);
