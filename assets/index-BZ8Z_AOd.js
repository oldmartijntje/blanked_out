var tt=Object.defineProperty;var et=(s,t,e)=>t in s?tt(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var g=(s,t,e)=>(et(s,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(n){if(n.ep)return;n.ep=!0;const r=e(n);fetch(n.href,r)}})();const d={baseUrl:"blanked_out",assetsPath:"assets",keys:{upKeys:["ArrowUp","KeyW"],downKeys:["ArrowDown","KeyS"],leftKeys:["ArrowLeft","KeyA"],rightKeys:["ArrowRight","KeyD"]},sizes:{gridSize:64,BackgroundWidth:1280,BackgroundHeight:1280}},z="LEFT",M="RIGHT",H="UP",K="DOWN",st="Space",N={UP:d.keys.upKeys,DOWN:d.keys.downKeys,LEFT:d.keys.leftKeys,RIGHT:d.keys.rightKeys,SPACE:[st]},O=[z,M,H,K];class it{constructor(){this.heldDirections=[],this.keys={},this.lastKeys={},document.addEventListener("keydown",t=>{this.keys[t.code]=!0,this.getDirection(t.code,!0)}),document.addEventListener("keyup",t=>{this.keys[t.code]=!1,this.getDirection(t.code,!1)}),document.addEventListener("DOMContentLoaded",()=>{for(const t of Object.keys(N))for(const e of N[t]){const i=document.querySelectorAll(`.${e}.gameController`);for(const n of i)n.addEventListener("mousedown",()=>{O.includes(t)&&this.onKeyPressed(t),this.keys[e]=!0}),n.addEventListener("mouseup",()=>{O.includes(t)&&this.onKeyReleased(t),this.keys[e]=!1}),n.addEventListener("touchstart",r=>{r.preventDefault(),O.includes(t)&&this.onKeyPressed(t),this.keys[e]=!0}),n.addEventListener("touchend",r=>{r.preventDefault(),O.includes(t)&&this.onKeyReleased(t),this.keys[e]=!1})}})}get direction(){return this.heldDirections[0]}getDirection(t,e){for(const i of Object.keys(N))N[i].includes(t)&&O.includes(i)&&(e?this.onKeyPressed(i):this.onKeyReleased(i))}update(){this.lastKeys={...this.keys}}getActionJustPressed(t){let e=!1;return this.keys[t]&&!this.lastKeys[t]&&(e=!0),e}onKeyPressed(t){this.heldDirections.includes(t)||this.heldDirections.unshift(t)}onKeyReleased(t){const e=this.heldDirections.indexOf(t);e>-1&&this.heldDirections.splice(e,1)}}class f{constructor(t=0,e=0){this.x=t,this.y=e}duplicate(){return new f(this.x,this.y)}matches(t){return this.x===t.x&&this.y===t.y}toString(){return`Vector2(${this.x}, ${this.y})`}toNeighbor(t){let e=this.x,i=this.y;switch(t){case H:i-=d.sizes.gridSize;break;case K:i+=d.sizes.gridSize;break;case z:e-=d.sizes.gridSize;break;case M:e+=d.sizes.gridSize;break}if(e==this.x&&i==this.y)throw new Error("Invalid direction "+t+" for "+this.toString());return new f(e,i)}}class nt{constructor(t,e){g(this,"mainLoop",t=>{if(!this.isRunning)return;let e=t-this.lastFrameTime;for(this.lastFrameTime=t,this.accumulatedTime+=e;this.accumulatedTime>=this.timeStep;)this.update(this.timeStep),this.accumulatedTime-=this.timeStep;this.render(),this.rafId=requestAnimationFrame(this.mainLoop)});this.lastFrameTime=0,this.accumulatedTime=0,this.timeStep=1e3/60,this.update=t,this.render=e,this.rafId=null,this.isRunning=!1}start(){this.isRunning||(this.isRunning=!0,this.rafId=requestAnimationFrame(this.mainLoop))}stop(){this.rafId||cancelAnimationFrame(this.rafId),this.isRunning=!1}}class rt{constructor(){g(this,"callbacks",[]);g(this,"nextId",0)}emit(t,e){this.callbacks.forEach(i=>{i.eventName===t&&i.callback(e)})}on(t,e,i){return this.nextId++,this.callbacks.push({id:this.nextId,eventName:t,caller:e,callback:i}),this.nextId}off(t){this.callbacks=this.callbacks.filter(e=>e.id!==t)}unsubscribe(t){this.callbacks=this.callbacks.filter(e=>e.caller!==t)}}const p=new rt;class m{}g(m,"PLAYER_PICK_UP_ITEM","PLAYER_PICK_UP_ITEM"),g(m,"CHANGE_SCENE","CHANGE_SCENE"),g(m,"START_TEXT_BOX","START_TEXT_BOX"),g(m,"END_TEXT_BOX","END_TEXT_BOX"),g(m,"CAMERA_POSITION","CAMERA_POSITION"),g(m,"DO_ACTION_ON_COORDINATE","DO_ACTION_ON_COORDINATE");class _{constructor({position:t}){this.position=t??new f(0,0),this.children=[],this.parent=null,this.hasBeenInitiated=!1,this.isSolid=!1,this.drawLayer=null}stepEntry(t,e){this.children.forEach(i=>i.stepEntry(t,e)),this.hasBeenInitiated||(this.hasBeenInitiated=!0,this.onInit()),this.step(t,e)}onInit(){}step(t){}draw(t,e,i){const n=e+this.position.x,r=i+this.position.y;this.drawImage(t,n,r),this.getDrawChildrenOrdered().forEach(o=>o.draw(t,n,r))}getDrawChildrenOrdered(){return[...this.children].sort((t,e)=>e.drawLayer==="FLOOR"||t.position.y>e.position.y?1:-1)}drawImage(t,e,i){}destroy(){this.children.forEach(t=>t.destroy()),this.parent&&this.parent.removeChild(this)}addChild(t){t.parent=this,this.children.push(t)}removeChild(t){p.unsubscribe(t),this.children=this.children.filter(e=>e!==t)}}class ot extends _{constructor(){super({});g(this,"zoom",1);this.zoom=1,this.offset=new f(0,0),this.onInit()}onInit(){p.on(m.CAMERA_POSITION,this,e=>{e.focus&&this.centerPositionOnTarget(e.position)}),p.on(m.CHANGE_SCENE,this,e=>{this.centerPositionOnTarget(e.heroStartPosition)})}centerPositionOnTarget(e){this.position=new f(-e.x+632,-e.y+632)}}class at{constructor(){this.flags=new Map}add(t){this.flags.set(t,!0)}remove(t){this.flags.delete(t)}getRelevantScenario(t=[]){return t.find(e=>{const i=e.bypass??[];for(let r=0;r<i.length;r++){const o=i[r];if(this.flags.has(o))return!1}const n=e.requires??[];for(let r=0;r<n.length;r++){const o=n[r];if(!this.flags.has(o))return!1}return!0})}}const b=new at;class ct{constructor(){this.toLoad={hero:"sprites/hero-sheet.png",shadow:"sprites/shadow.png",rod:"sprites/rod.png",exit:"sprites/exit.png",sky:"sprites/sky.png",ground:"sprites/ground.png",cave:"sprites/cave.png",caveGround:"sprites/cave-ground.png",knight:"sprites/knight-sheet-1.png",textBox:"sprites/text-box.png",portraits:"sprites/portraits-sheet.png",fontWhite:"sprites/sprite-font-white.png"},this.images={};var t="";try{t="/"+d.baseUrl+"/"+d.assetsPath+"/"}catch(e){console.log(e),t="/"+d.baseUrl+"/"+d.assetsPath+"/"}console.log(`"${t}"`),Object.keys(this.toLoad).forEach(e=>{const i=new Image;i.src=t+this.toLoad[e],this.images[e]={image:i,isLoaded:!1},i.onload=()=>{this.images[e].isLoaded=!0}})}}const x=new ct;class I extends _{constructor({resource:t,frameSize:e,hFrames:i,vFrames:n,frame:r,scale:o,position:h,animations:T}){super({position:h??new f(0,0)}),this.resource=t,this.frameSize=e??new f(d.sizes.gridSize,d.sizes.gridSize),this.hFrames=i??1,this.vFrames=n??1,this.frame=r??0,this.frameMap=new Map,this.scale=o??1,this.position=h??new f(0,0),this.animations=T??null,this.buildFrameMap()}buildFrameMap(){let t=0;for(let e=0;e<this.vFrames;e++)for(let i=0;i<this.hFrames;i++)this.frameMap.set(t,new f(i*this.frameSize.x,e*this.frameSize.y)),t++}step(t){this.animations&&(this.animations.step(t),this.frame=this.animations.frame)}drawImage(t,e,i){if(!this.resource.isLoaded)return;let n=0,r=0;const o=this.frameMap.get(this.frame);o&&(n=o.x,r=o.y);const h=this.frameSize.x,T=this.frameSize.y;t.drawImage(this.resource.image,n,r,h,T,e,i,h*this.scale,T*this.scale)}}class ht extends _{constructor(){super({position:new f(0,1)}),this.items=[],this.drawLayer="HUD",this.nextId=0,this.renderInventory()}renderInventory(){this.children.forEach(t=>t.destroy()),this.items.forEach((t,e)=>{const i=new I({resource:t.image,position:new f(e*12,0)});this.addChild(i)})}removeFromInventory(t){this.items=this.items.filter(e=>e.id!==t),this.renderInventory()}onInit(){p.on(m.PLAYER_PICK_UP_ITEM,this,t=>{this.items.push({id:this.nextId++,image:t.image}),console.log(this.items),this.renderInventory()})}}const lt=5,u=new Map;u.set("i",2);u.set("j",4);u.set("l",3);u.set("r",4);u.set("t",4);u.set("u",4);u.set("v",4);u.set("x",4);u.set("y",4);u.set("z",4);u.set("E",4);u.set("F",4);u.set("M",7);u.set("W",7);u.set(" ",3);u.set("'",2);u.set("!",1);const dt=s=>u.get(s)??lt,Y=new Map;["abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ","0123456789 __",".!-,?'"].join("").split("").forEach((s,t)=>{Y.set(s,t)});const ut=s=>Y.get(s)??null,ft=4,mt=1,gt=3,pt=20,wt=1,Et=1;class yt extends _{constructor(t={}){super({position:new f(32,108)}),this.drawLayer="HUD";const e=t.string??"Default Text";this.words=e.split(" ").map(i=>{let n=0;const r=i.split("").map(o=>{const h=dt(o);return n+=h,{width:h,sprite:new I({resource:x.images.fontWhite,hFrames:13,vFrames:6,frame:ut(o)})}});return{wordWidth:n,chars:r}}),this.backdrop=new I({resource:x.images.textBox,frameSize:new f(256,64)}),t.portraitFrame!==null&&t.portraitFrame!==void 0?this.portrait=new I({resource:x.images.portraits,hFrames:4,vFrames:1,frame:t.portraitFrame??0}):this.portrait=null,this.showingIndex=0,this.finalIndex=this.words.reduce((i,n)=>i+n.chars.length,0),this.textSpeed=pt,this.timeUntilNextShow=this.textSpeed}step(t,e){const i=e.input;if(i!=null&&i.getActionJustPressed("Space")){if(this.showingIndex<this.finalIndex){this.showingIndex=this.finalIndex;return}p.emit(m.END_TEXT_BOX)}this.timeUntilNextShow-=t,this.timeUntilNextShow<=0&&(this.showingIndex+=Et,this.timeUntilNextShow+=this.textSpeed)}drawImage(t,e,i){this.backdrop.drawImage(t,e,i),this.portrait&&this.portrait.drawImage(t,e+6,i+6);const o=7,h=7,T=240,q=14,j=18,$=2;let C=o,R=h;this.portrait&&(C+=j,R+=$);let S=e+C,F=i+R,v=0;this.words.forEach(k=>{e+T-S<k.wordWidth&&(S=e+C,F+=q),k.chars.forEach(J=>{if(v>this.showingIndex)return;const{sprite:Z,width:Q}=J,V=S-ft;Z.draw(t,V,F),S+=Q+mt,v+=wt}),S+=gt})}}class Tt extends _{constructor(){super({}),this.level=null,this.input=new it,this.camera=new ot}onInit(){const t=new ht;this.addChild(t),p.on(m.CHANGE_SCENE,this,e=>{this.setLevel(e)}),p.on(m.DO_ACTION_ON_COORDINATE,this,e=>{if(typeof e.getContent=="function"){const i=e.getContent();if(!i)return;i.addsFlags&&i.addsFlags.forEach(h=>{b.add(h)}),i.removesFlags&&i.removesFlags.forEach(h=>{b.remove(h)});const n={string:i.string,portraitFrame:i.portraitFrame??null};let r=null;r=new yt(n),this.addChild(r),p.emit(m.START_TEXT_BOX);const o=p.on(m.END_TEXT_BOX,this,()=>{r.destroy(),p.off(o)})}})}setLevel(t){this.level&&this.level.destroy(),this.level=t,this.addChild(this.level)}drawBackground(t){var e;(e=this.level)==null||e.background.drawImage(t,0,0)}drawObjects(t){this.children.forEach(e=>{e.drawLayer!=="HUD"&&e.draw(t,0,0)})}drawForeground(t){this.children.forEach(e=>{e.drawLayer==="HUD"&&e.draw(t,0,0)})}}class It extends _{constructor(){super({}),this.background=null,this.walls=new Set}}class _t extends It{constructor(t={}){super({}),this.background=new I({resource:x.images.sky,frameSize:new f(d.sizes.BackgroundWidth,d.sizes.BackgroundHeight),scale:8});const e=new I({resource:x.images.ground,frameSize:new f(d.sizes.BackgroundWidth,d.sizes.BackgroundHeight),scale:4});this.addChild(e)}onInit(){}}const a=document.querySelector("#game-canvas"),w=a.getContext("2d"),c=new Tt({position:new f(0,0)});c.setLevel(new _t);let l=1;const X=.05;let D=!1,E=0,y=0,A=0,P=!1;const B=.5,W=3;let L;const Dt=s=>{var t;c.stepEntry(s,c),(t=c.input)==null||t.update()},U=s=>{const t=a.getBoundingClientRect(),e=(s.clientX||s.touches[0].clientX)-t.left,i=(s.clientY||s.touches[0].clientY)-t.top,n=(e-a.width/2)/l-c.camera.position.x,r=(i-a.height/2)/l-c.camera.position.y;console.log("Clicked at world position:",n,r)},St=()=>{w.clearRect(0,0,a.width,a.height),c.drawBackground(w),w.save(),c.camera&&(w.translate(a.width/2,a.height/2),w.scale(l,l),w.translate(-a.width/2+c.camera.position.x,-a.height/2+c.camera.position.y)),c.drawObjects(w,0,0),w.restore(),c.drawForeground(w)},Ot=new nt(Dt,St);Ot.start();const xt=s=>{D=!0,s.touches?(E=s.touches[0].clientX,y=s.touches[0].clientY):(E=s.clientX,y=s.clientY),L=new Date().getTime()},At=s=>{if(!D)return;let t,e;s.touches?(t=s.touches[0].clientX,e=s.touches[0].clientY):(t=s.clientX,e=s.clientY);const i=(t-E)/l,n=(e-y)/l;c.camera.position.x+=i,c.camera.position.y+=n,E=t,y=e},G=s=>{new Date().getTime()-L<200&&!P&&U(s),D=!1},Nt=s=>{s.preventDefault();const t=s.deltaY<0?1+X:1-X;l*=t,l=Math.max(B,Math.min(W,l))},Lt=s=>{if(s.touches.length===2){s.preventDefault();const t=s.touches[0],e=s.touches[1];A=Math.hypot(e.clientX-t.clientX,e.clientY-t.clientY)}else s.touches.length===1&&(D=!0,E=s.touches[0].clientX,y=s.touches[0].clientY,L=new Date().getTime())},Ct=s=>{if(s.touches.length===2){s.preventDefault();const t=s.touches[0],e=s.touches[1],i=Math.hypot(e.clientX-t.clientX,e.clientY-t.clientY);if(A>0){const n=i/A,r=l*n;if(r>=B&&r<=W){a.getBoundingClientRect();const o=(t.clientX+e.clientX)/2,h=(t.clientY+e.clientY)/2;(o-a.width/2)/l+c.camera.position.x,(h-a.height/2)/l+c.camera.position.y,l=r,(o-a.width/2)/l+c.camera.position.x,(h-a.height/2)/l+c.camera.position.y,c.camera.position.x+=o-(o-E)*l,c.camera.position.y+=h-(h-y)*l}}A=i}else if(s.touches.length===1&&D){const t=s.touches[0].clientX,e=s.touches[0].clientY,i=(t-E)/l,n=(e-y)/l;c.camera.position.x+=i,c.camera.position.y+=n,E=t,y=e}},Pt=s=>{s.touches.length<2&&(A=0,P=!1),new Date().getTime()-L<200&&!P&&s.touches.length===0&&U(s),s.touches.length===0&&(D=!1)};a.addEventListener("mousedown",xt);a.addEventListener("mousemove",At);a.addEventListener("mouseup",G);a.addEventListener("mouseleave",G);a.addEventListener("wheel",Nt,{passive:!1});a.addEventListener("touchstart",Lt,{passive:!1});a.addEventListener("touchmove",Ct,{passive:!1});a.addEventListener("touchend",Pt);
