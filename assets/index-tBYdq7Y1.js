var V=Object.defineProperty;var J=(n,t,e)=>t in n?V(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var d=(n,t,e)=>(J(n,typeof t!="symbol"?t+"":t,e),e);import tt from"https://esm.sh/mqtt@5.10.3";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}})();const h={baseUrl:"blanked_out",assetsPath:"assets",keys:{upKeys:["ArrowUp","KeyW"],downKeys:["ArrowDown","KeyS"],leftKeys:["ArrowLeft","KeyA"],rightKeys:["ArrowRight","KeyD"],zoomMinus:["NumpadSubtract"],zoomPlus:["NumpadAdd"]},sizes:{gridSize:64,BackgroundWidth:1280,BackgroundHeight:1280},MQTT:{"brokerUrl+port":"test.mosquitto.org:8081",topicBase:"https://oldmartijntje.github.io/blanked_out/"}};class et{constructor(){d(this,"callbacks",[]);d(this,"nextId",0)}emit(t,e){this.callbacks.forEach(s=>{s.eventName===t&&s.callback(e)})}on(t,e,s){return this.nextId++,this.callbacks.push({id:this.nextId,eventName:t,caller:e,callback:s}),this.nextId}off(t){this.callbacks=this.callbacks.filter(e=>e.id!==t)}unsubscribe(t){this.callbacks=this.callbacks.filter(e=>e.caller!==t)}}const p=new et;class l{}d(l,"PLAYER_PICK_UP_ITEM","PLAYER_PICK_UP_ITEM"),d(l,"CHANGE_SCENE","CHANGE_SCENE"),d(l,"START_TEXT_BOX","START_TEXT_BOX"),d(l,"END_TEXT_BOX","END_TEXT_BOX"),d(l,"CAMERA_POSITION","CAMERA_POSITION"),d(l,"DO_ACTION_ON_COORDINATE","DO_ACTION_ON_COORDINATE"),d(l,"USER_CLICK_CANVAS","USER_CLICK_CANVAS"),d(l,"USER_DOUBLE_CLICK_CANVAS","USER_DOUBLE_CLICK_CANVAS");const K="LEFT",B="RIGHT",H="UP",G="DOWN",W="Space",v="ZOOM_MINUS",k="ZOOM_PLUS",R=.05,M=.5,z=3,P={UP:h.keys.upKeys,DOWN:h.keys.downKeys,LEFT:h.keys.leftKeys,RIGHT:h.keys.rightKeys,SPACE:[W],ZOOM_MINUS:h.keys.zoomMinus,ZOOM_PLUS:h.keys.zoomPlus},y=[K,B,H,G,W,v,k];class st{constructor(){this.heldDirections=[],this.keys={},this.lastKeys={},this.camera,this.canvas,this.isDragging=!1,this.startX=0,this.startY=0,this.lastX=0,this.lastY=0,this.lastTouchDistance=0,this.isZoomLimitReached=!1,this.dragStartTime,document.addEventListener("keydown",t=>{this.keys[t.code]=!0,this.getDirection(t.code,!0)}),document.addEventListener("keyup",t=>{this.keys[t.code]=!1,this.getDirection(t.code,!1)}),document.addEventListener("DOMContentLoaded",()=>{for(const t of Object.keys(P))for(const e of P[t]){const s=document.querySelectorAll(`.${e}.gameController`);for(const i of s)i.addEventListener("mousedown",()=>{y.includes(t)&&this.onKeyPressed(t),this.keys[e]=!0}),i.addEventListener("mouseup",()=>{y.includes(t)&&this.onKeyReleased(t),this.keys[e]=!1}),i.addEventListener("touchstart",o=>{o.preventDefault(),y.includes(t)&&this.onKeyPressed(t),this.keys[e]=!0}),i.addEventListener("touchend",o=>{o.preventDefault(),y.includes(t)&&this.onKeyReleased(t),this.keys[e]=!1})}})}get direction(){return this.heldDirections[0]}getDirection(t,e){for(const s of Object.keys(P))P[s].includes(t)&&y.includes(s)&&(e?this.onKeyPressed(s):this.onKeyReleased(s))}update(){this.lastKeys={...this.keys},this.heldDirections.length>0&&(this.heldDirections[0]===v||this.heldDirections[0]===k)&&this.camera&&(this.heldDirections[0]===v&&this.camera.zoom>M?this.camera.zoom-=R/2:this.heldDirections[0]===k&&this.camera.zoom<z&&(this.camera.zoom+=R/2))}getActionJustPressed(t){let e=!1;return this.keys[t]&&!this.lastKeys[t]&&(e=!0),e}onKeyPressed(t){this.heldDirections.includes(t)||this.heldDirections.unshift(t)}onKeyReleased(t){const e=this.heldDirections.indexOf(t);e>-1&&this.heldDirections.splice(e,1)}onPointerDown(t){this.isDragging=!0,t.touches?(this.lastX=t.touches[0].clientX,this.lastY=t.touches[0].clientY):(this.lastX=t.clientX,this.lastY=t.clientY),this.dragStartTime=new Date().getTime()}onPointerMove(t,e){if(!this.isDragging)return;let s,i;t.touches?(s=t.touches[0].clientX,i=t.touches[0].clientY):(s=t.clientX,i=t.clientY);const o=(s-this.lastX)/e.zoom,r=(i-this.lastY)/e.zoom;e.position.x+=o,e.position.y+=r,this.lastX=s,this.lastY=i}onPointerUp(t,e){new Date().getTime()-this.dragStartTime<200&&!this.isZoomLimitReached&&this.handleClick(t,e),this.isDragging=!1}onWheel(t,e){t.preventDefault();const s=t.deltaY<0?1+R:1-R;e.zoom*=s,e.zoom=Math.max(M,Math.min(z,e.zoom))}onTouchStart(t){if(t.touches.length===2){t.preventDefault();const e=t.touches[0],s=t.touches[1];this.lastTouchDistance=Math.hypot(s.clientX-e.clientX,s.clientY-e.clientY)}else t.touches.length===1&&(this.isDragging=!0,this.lastX=t.touches[0].clientX,this.lastY=t.touches[0].clientY,this.dragStartTime=new Date().getTime())}onTouchMove(t,e){if(t.touches.length===2){t.preventDefault();const s=t.touches[0],i=t.touches[1],o=Math.hypot(i.clientX-s.clientX,i.clientY-s.clientY);if(this.lastTouchDistance>0){const r=o/this.lastTouchDistance,c=e.zoom*r;if(c>=M&&c<=z){canvas.getBoundingClientRect();const f=(s.clientX+i.clientX)/2,w=(s.clientY+i.clientY)/2,S=(f-canvas.width/2)/e.zoom+e.position.x,I=(w-canvas.height/2)/e.zoom+e.position.y;e.zoom=c;const A=(f-canvas.width/2)/e.zoom+e.position.x,L=(w-canvas.height/2)/e.zoom+e.position.y;e.position.x+=S-A,e.position.y+=I-L}}this.lastTouchDistance=o}else if(t.touches.length===1&&this.isDragging){const s=t.touches[0].clientX,i=t.touches[0].clientY,o=(s-this.lastX)/e.zoom,r=(i-this.lastY)/e.zoom;e.position.x+=o,e.position.y+=r,this.lastX=s,this.lastY=i}}onTouchEnd(t,e){t.touches.length<2&&(this.lastTouchDistance=0,this.isZoomLimitReached=!1),new Date().getTime()-this.dragStartTime<200&&!this.isZoomLimitReached&&t.touches.length===0&&this.handleClick(t,e),t.touches.length===0&&(this.isDragging=!1)}handleClick(t,e,s=l.USER_CLICK_CANVAS){if(!this.canvas)return;const i=this.canvas.getBoundingClientRect(),o=(t.clientX||t.touches[0].clientX)-i.left,r=(t.clientY||t.touches[0].clientY)-i.top,c=(o-this.canvas.width/2)/e.zoom-e.position.x,f=(r-this.canvas.height/2)/e.zoom-e.position.y;p.emit(s,{x:c,y:f})}registerMouseMovement(t,e){this.canvas=t,this.camera=e,t.addEventListener("mousedown",s=>{this.onPointerDown(s)}),t.addEventListener("mousemove",s=>{this.onPointerMove(s,e)}),t.addEventListener("mouseup",s=>{this.onPointerUp(s,e)}),t.addEventListener("mouseleave",s=>{this.onPointerUp(s,e)}),t.addEventListener("dblclick",s=>{this.handleClick(s,e,l.USER_DOUBLE_CLICK_CANVAS)}),t.addEventListener("wheel",s=>{this.onWheel(s,e)},{passive:!1}),t.addEventListener("touchstart",s=>{this.onTouchStart(s)},{passive:!1}),t.addEventListener("touchmove",s=>{this.onTouchMove(s,e)},{passive:!1}),t.addEventListener("touchend",s=>{this.onTouchEnd(s,e)})}}class a{constructor(t=0,e=0){this.x=t,this.y=e}duplicate(){return new a(this.x,this.y)}matches(t){return this.x===t.x&&this.y===t.y}toString(){return`Vector2(${this.x}, ${this.y})`}toNeighbor(t){let e=this.x,s=this.y;switch(t){case H:s-=h.sizes.gridSize;break;case G:s+=h.sizes.gridSize;break;case K:e-=h.sizes.gridSize;break;case B:e+=h.sizes.gridSize;break}if(e==this.x&&s==this.y)throw new Error("Invalid direction "+t+" for "+this.toString());return new a(e,s)}}class it{constructor(t,e){d(this,"mainLoop",t=>{if(!this.isRunning)return;let e=t-this.lastFrameTime;for(this.lastFrameTime=t,this.accumulatedTime+=e;this.accumulatedTime>=this.timeStep;)this.update(this.timeStep),this.accumulatedTime-=this.timeStep;this.render(),this.rafId=requestAnimationFrame(this.mainLoop)});this.lastFrameTime=0,this.accumulatedTime=0,this.timeStep=1e3/60,this.update=t,this.render=e,this.rafId=null,this.isRunning=!1}start(){this.isRunning||(this.isRunning=!0,this.rafId=requestAnimationFrame(this.mainLoop))}stop(){this.rafId||cancelAnimationFrame(this.rafId),this.isRunning=!1}}class D{constructor({position:t}){this.position=t??new a(0,0),this.children=[],this.parent=null,this.hasBeenInitiated=!1,this.isSolid=!1,this.drawLayer=null}stepEntry(t,e){this.children.forEach(s=>s.stepEntry(t,e)),this.hasBeenInitiated||(this.hasBeenInitiated=!0,this.onInit()),this.step(t,e)}onInit(){}step(t){}draw(t,e,s){const i=e+this.position.x,o=s+this.position.y;this.drawImage(t,i,o),this.getDrawChildrenOrdered().forEach(r=>r.draw(t,i,o))}getDrawChildrenOrdered(){return[...this.children].sort((t,e)=>e.drawLayer==="FLOOR"||t.position.y>e.position.y?1:-1)}drawImage(t,e,s){}destroy(){this.children.forEach(t=>t.destroy()),this.parent&&this.parent.removeChild(this)}addChild(t){t.parent=this,this.children.push(t)}removeChild(t){p.unsubscribe(t),this.children=this.children.filter(e=>e!==t)}}class ot extends D{constructor(){super({});d(this,"zoom",1);this.zoom=1,this.offset=new a(0,0),this.onInit()}onInit(){p.on(l.CAMERA_POSITION,this,e=>{e.focus&&this.centerPositionOnTarget(e.position)}),p.on(l.CHANGE_SCENE,this,e=>{this.centerPositionOnTarget(e.heroStartPosition)})}centerPositionOnTarget(e){this.position=new a(-e.x+632,-e.y+632)}}class nt{constructor(){this.flags=new Map}add(t){this.flags.set(t,!0)}remove(t){this.flags.delete(t)}getRelevantScenario(t=[]){return t.find(e=>{const s=e.bypass??[];for(let o=0;o<s.length;o++){const r=s[o];if(this.flags.has(r))return!1}const i=e.requires??[];for(let o=0;o<i.length;o++){const r=i[o];if(!this.flags.has(r))return!1}return!0})}}const Y=new nt;class rt{constructor(){this.toLoad={hero:"sprites/hero-sheet.png",shadow:"sprites/shadow.png",rod:"sprites/rod.png",exit:"sprites/exit.png",sky:"sprites/sky.png",ground:"sprites/ground.png",cave:"sprites/cave.png",caveGround:"sprites/cave-ground.png",knight:"sprites/knight-sheet-1.png",textBox:"sprites/text-box.png",portraits:"sprites/portraits-sheet.png",fontWhite:"sprites/sprite-font-white.png"},this.images={};var t="";try{t="/"+h.baseUrl+"/"+h.assetsPath+"/"}catch(e){console.log(e),t="/"+h.baseUrl+"/"+h.assetsPath+"/"}console.log(`"${t}"`),Object.keys(this.toLoad).forEach(e=>{const s=new Image;s.src=t+this.toLoad[e],this.images[e]={image:s,isLoaded:!1},s.onload=()=>{this.images[e].isLoaded=!0}})}}const N=new rt;class _ extends D{constructor({resource:t,frameSize:e,hFrames:s,vFrames:i,frame:o,scale:r,position:c,animations:f}){super({position:c??new a(0,0)}),this.resource=t,this.frameSize=e??new a(h.sizes.gridSize,h.sizes.gridSize),this.hFrames=s??1,this.vFrames=i??1,this.frame=o??0,this.frameMap=new Map,this.scale=r??1,this.position=c??new a(0,0),this.animations=f??null,this.buildFrameMap()}buildFrameMap(){let t=0;for(let e=0;e<this.vFrames;e++)for(let s=0;s<this.hFrames;s++)this.frameMap.set(t,new a(s*this.frameSize.x,e*this.frameSize.y)),t++}step(t){this.animations&&(this.animations.step(t),this.frame=this.animations.frame)}drawImage(t,e,s){if(!this.resource.isLoaded)return;let i=0,o=0;const r=this.frameMap.get(this.frame);r&&(i=r.x,o=r.y);const c=this.frameSize.x,f=this.frameSize.y;t.drawImage(this.resource.image,i,o,c,f,e,s,c*this.scale,f*this.scale)}}class ht extends D{constructor(){super({position:new a(0,1)}),this.items=[],this.drawLayer="HUD",this.nextId=0,this.renderInventory()}renderInventory(){this.children.forEach(t=>t.destroy()),this.items.forEach((t,e)=>{const s=new _({resource:t.image,position:new a(e*12,0)});this.addChild(s)})}removeFromInventory(t){this.items=this.items.filter(e=>e.id!==t),this.renderInventory()}onInit(){p.on(l.PLAYER_PICK_UP_ITEM,this,t=>{this.items.push({id:this.nextId++,image:t.image}),console.log(this.items),this.renderInventory()})}}const at=5,g=new Map;g.set("i",2);g.set("j",4);g.set("l",3);g.set("r",4);g.set("t",4);g.set("u",4);g.set("v",4);g.set("x",4);g.set("y",4);g.set("z",4);g.set("E",4);g.set("F",4);g.set("M",7);g.set("W",7);g.set(" ",3);g.set("'",2);g.set("!",1);const ct=n=>g.get(n)??at,x=new Map;["abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ","0123456789 __",".!-,?'"].join("").split("").forEach((n,t)=>{x.set(n,t)});const lt=n=>x.get(n)??null,dt=4,ut=1,gt=3,ft=20,mt=1,pt=1;class wt extends D{constructor(t={}){super({position:new a(32,108)}),this.drawLayer="HUD";const e=t.string??"Default Text";this.words=e.split(" ").map(s=>{let i=0;const o=s.split("").map(r=>{const c=ct(r);return i+=c,{width:c,sprite:new _({resource:N.images.fontWhite,hFrames:13,vFrames:6,frame:lt(r)})}});return{wordWidth:i,chars:o}}),this.backdrop=new _({resource:N.images.textBox,frameSize:new a(256,64)}),t.portraitFrame!==null&&t.portraitFrame!==void 0?this.portrait=new _({resource:N.images.portraits,hFrames:4,vFrames:1,frame:t.portraitFrame??0}):this.portrait=null,this.showingIndex=0,this.finalIndex=this.words.reduce((s,i)=>s+i.chars.length,0),this.textSpeed=ft,this.timeUntilNextShow=this.textSpeed}step(t,e){const s=e.input;if(s!=null&&s.getActionJustPressed("Space")){if(this.showingIndex<this.finalIndex){this.showingIndex=this.finalIndex;return}p.emit(l.END_TEXT_BOX)}this.timeUntilNextShow-=t,this.timeUntilNextShow<=0&&(this.showingIndex+=pt,this.timeUntilNextShow+=this.textSpeed)}drawImage(t,e,s){this.backdrop.drawImage(t,e,s),this.portrait&&this.portrait.drawImage(t,e+6,s+6);const r=7,c=7,f=240,w=14,S=18,I=2;let A=r,L=c;this.portrait&&(A+=S,L+=I);let O=e+A,F=s+L,U=0;this.words.forEach(X=>{e+f-O<X.wordWidth&&(O=e+A,F+=w),X.chars.forEach($=>{if(U>this.showingIndex)return;const{sprite:j,width:Q}=$,Z=O-dt;j.draw(t,Z,F),O+=Q+ut,U+=mt}),O+=gt})}}class Tt extends D{constructor(){super({}),this.level=null,this.input=new st,this.camera=new ot}onInit(){p.on(l.USER_CLICK_CANVAS,this,e=>{console.log(e,1)}),p.on(l.USER_DOUBLE_CLICK_CANVAS,this,e=>{console.log(e,2)});const t=new ht;this.addChild(t),p.on(l.CHANGE_SCENE,this,e=>{this.setLevel(e)}),p.on(l.DO_ACTION_ON_COORDINATE,this,e=>{if(typeof e.getContent=="function"){const s=e.getContent();if(!s)return;s.addsFlags&&s.addsFlags.forEach(c=>{Y.add(c)}),s.removesFlags&&s.removesFlags.forEach(c=>{Y.remove(c)});const i={string:s.string,portraitFrame:s.portraitFrame??null};let o=null;o=new wt(i),this.addChild(o),p.emit(l.START_TEXT_BOX);const r=p.on(l.END_TEXT_BOX,this,()=>{o.destroy(),p.off(r)})}})}registerMouseMovement(t){this.input.registerMouseMovement(t,this.camera)}setLevel(t){this.level&&this.level.destroy(),this.level=t,this.addChild(this.level)}drawBackground(t){var e;(e=this.level)==null||e.background.drawImage(t,0,0)}drawObjects(t){this.children.forEach(e=>{e.drawLayer!=="HUD"&&e.draw(t,0,0)})}drawForeground(t){this.children.forEach(e=>{e.drawLayer==="HUD"&&e.draw(t,0,0)})}}class Et extends D{constructor(){super({}),this.background=null,this.walls=new Set}}class u{}d(u,"CIRCLE","circle"),d(u,"SQUARE","square"),d(u,"TRIANGLE","triangle"),d(u,"HEXAGON","hexagon"),d(u,"PENTAGON","pentagon"),d(u,"CUSTOM","custom");class C extends _{constructor({color:t,width:e,height:s,figure:i,position:o,customShapeDrawingFunction:r}){super({position:o??new a(0,0),resource:null}),this.color=t??"orange",this.width=e??h.sizes.gridSize,this.height=s??h.sizes.gridSize,this.figure=i??u.SQUARE,this.customShapeDrawingFunction=r??null}drawImage(t,e,s){t.fillStyle=this.color,this.figure==u.CUSTOM&&this.customShapeDrawingFunction?this.customShapeDrawingFunction(t,e,s):this.figure==u.SQUARE?t.fillRect(e,s,this.width,this.height):this.figure==u.CIRCLE?(t.beginPath(),t.arc(e+this.width/2,s+this.width/2,this.width/2,0,2*Math.PI),t.fill()):this.figure==u.TRIANGLE?(t.beginPath(),t.moveTo(e,s),t.lineTo(e+this.width,s),t.lineTo(e+this.width/2,s+this.height),t.fill()):this.figure==u.HEXAGON?(t.beginPath(),t.moveTo(e+this.width/4,s),t.lineTo(e+this.width*3/4,s),t.lineTo(e+this.width,s+this.height/2),t.lineTo(e+this.width*3/4,s+this.height),t.lineTo(e+this.width/4,s+this.height),t.lineTo(e,s+this.height/2),t.fill()):this.figure==u.PENTAGON&&(t.beginPath(),t.moveTo(e+this.width/2,s),t.lineTo(e+this.width,s+this.height*2/5),t.lineTo(e+this.width*3/4,s+this.height),t.lineTo(e+this.width/4,s+this.height),t.lineTo(e,s+this.height*2/5),t.fill())}}const q={};for(let n=0;n<8;n++)for(let t=0;t<8;t++)q[`${n}-${t}`]={x:n,y:t,color:(n+t)%2===0?"white":"black",occupied:!1};console.log(q);class St extends Et{constructor(t={}){super({}),this.background=new _({resource:N.images.sky,frameSize:new a(h.sizes.BackgroundWidth,h.sizes.BackgroundHeight),scale:8});const e=new _({resource:N.images.ground,frameSize:new a(h.sizes.BackgroundWidth,h.sizes.BackgroundHeight),scale:4}),s=new C({color:"blue",width:64,height:64,figure:u.SQUARE,position:new a(0,0)}),i=new C({color:"red",width:64,height:64,figure:u.CIRCLE,position:new a(64,0)}),o=new C({color:"green",width:64,height:64,figure:u.TRIANGLE,position:new a(128,0)}),r=new C({color:"yellow",width:64,height:64,figure:u.HEXAGON,position:new a(192,0)}),c=new C({color:"black",width:64,height:64,figure:u.PENTAGON,position:new a(256,0)}),f=new C({figure:u.CUSTOM,position:new a(0,64),customShapeDrawingFunction:(w,S,I)=>{w.beginPath(),w.moveTo(S+32,I),w.lineTo(S+64,I+64),w.lineTo(S,I+640),w.fill()}});this.addChild(e),this.addChild(s),this.addChild(i),this.addChild(o),this.addChild(r),this.addChild(c),this.addChild(f)}onInit(){}}const It="wss://"+h.MQTT["brokerUrl+port"],_t={clientId:`mqttjs_${Math.random().toString(16).slice(2,8)}`},b=tt.connect(It,_t);b.on("connect",()=>{console.log("Connected to MQTT broker")});b.on("message",(n,t)=>{console.log(`Received message: ${t.toString()} on topic: ${n}`)});const Ct=(n,t)=>{n=h.MQTT.topicBase+n,b.publish(n,t,{},e=>{e?console.error("Publish error:",e):console.log(`Message sent to ${n}: ${t}`)})},Dt=n=>{n=h.MQTT.topicBase+n,b.subscribe(n,t=>{t?console.error("Subscribe error:",t):console.log(`Subscribed to topic: ${n}`)})};Dt("test");Ct("test","Hello from MQTT service");const E=document.querySelector("#game-canvas"),T=E.getContext("2d"),m=new Tt({position:new a(0,0)});m.setLevel(new St);m.registerMouseMovement(E);const At=n=>{var t;m.stepEntry(n,m),(t=m.input)==null||t.update()},Ot=()=>{T.clearRect(0,0,E.width,E.height),m.drawBackground(T),T.save(),m.camera&&(T.translate(E.width/2,E.height/2),T.scale(m.camera.zoom,m.camera.zoom),T.translate(-E.width/2+m.camera.position.x,-E.height/2+m.camera.position.y)),m.drawObjects(T,0,0),T.restore(),m.drawForeground(T)},yt=new it(At,Ot);yt.start();
