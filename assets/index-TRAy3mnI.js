var tt=Object.defineProperty;var et=(i,t,e)=>t in i?tt(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var p=(i,t,e)=>(et(i,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=e(n);fetch(n.href,r)}})();const h={baseUrl:"blanked_out",assetsPath:"assets",keys:{upKeys:["ArrowUp","KeyW"],downKeys:["ArrowDown","KeyS"],leftKeys:["ArrowLeft","KeyA"],rightKeys:["ArrowRight","KeyD"]},sizes:{gridSize:64,canvasWidth:1280,canvasHeight:1280}},H="LEFT",K="RIGHT",W="UP",U="DOWN",st="Space",A={UP:h.keys.upKeys,DOWN:h.keys.downKeys,LEFT:h.keys.leftKeys,RIGHT:h.keys.rightKeys,SPACE:[st]},D=[H,K,W,U];class it{constructor(){this.heldDirections=[],this.keys={},this.lastKeys={},document.addEventListener("keydown",t=>{this.keys[t.code]=!0,this.getDirection(t.code,!0)}),document.addEventListener("keyup",t=>{this.keys[t.code]=!1,this.getDirection(t.code,!1)}),document.addEventListener("DOMContentLoaded",()=>{for(const t of Object.keys(A))for(const e of A[t]){const s=document.querySelectorAll(`.${e}.gameController`);for(const n of s)n.addEventListener("mousedown",()=>{D.includes(t)&&this.onKeyPressed(t),this.keys[e]=!0}),n.addEventListener("mouseup",()=>{D.includes(t)&&this.onKeyReleased(t),this.keys[e]=!1}),n.addEventListener("touchstart",r=>{r.preventDefault(),D.includes(t)&&this.onKeyPressed(t),this.keys[e]=!0}),n.addEventListener("touchend",r=>{r.preventDefault(),D.includes(t)&&this.onKeyReleased(t),this.keys[e]=!1})}})}get direction(){return this.heldDirections[0]}getDirection(t,e){for(const s of Object.keys(A))A[s].includes(t)&&D.includes(s)&&(e?this.onKeyPressed(s):this.onKeyReleased(s))}update(){this.lastKeys={...this.keys}}getActionJustPressed(t){let e=!1;return this.keys[t]&&!this.lastKeys[t]&&(e=!0),e}onKeyPressed(t){this.heldDirections.includes(t)||this.heldDirections.unshift(t)}onKeyReleased(t){const e=this.heldDirections.indexOf(t);e>-1&&this.heldDirections.splice(e,1)}}class d{constructor(t=0,e=0){this.x=t,this.y=e}duplicate(){return new d(this.x,this.y)}matches(t){return this.x===t.x&&this.y===t.y}toString(){return`Vector2(${this.x}, ${this.y})`}toNeighbor(t){let e=this.x,s=this.y;switch(t){case W:s-=h.sizes.gridSize;break;case U:s+=h.sizes.gridSize;break;case H:e-=h.sizes.gridSize;break;case K:e+=h.sizes.gridSize;break}if(e==this.x&&s==this.y)throw new Error("Invalid direction "+t+" for "+this.toString());return new d(e,s)}}class nt{constructor(t,e){p(this,"mainLoop",t=>{if(!this.isRunning)return;let e=t-this.lastFrameTime;for(this.lastFrameTime=t,this.accumulatedTime+=e;this.accumulatedTime>=this.timeStep;)this.update(this.timeStep),this.accumulatedTime-=this.timeStep;this.render(),this.rafId=requestAnimationFrame(this.mainLoop)});this.lastFrameTime=0,this.accumulatedTime=0,this.timeStep=1e3/60,this.update=t,this.render=e,this.rafId=null,this.isRunning=!1}start(){this.isRunning||(this.isRunning=!0,this.rafId=requestAnimationFrame(this.mainLoop))}stop(){this.rafId||cancelAnimationFrame(this.rafId),this.isRunning=!1}}class rt{constructor(){p(this,"callbacks",[]);p(this,"nextId",0)}emit(t,e){this.callbacks.forEach(s=>{s.eventName===t&&s.callback(e)})}on(t,e,s){return this.nextId++,this.callbacks.push({id:this.nextId,eventName:t,caller:e,callback:s}),this.nextId}off(t){this.callbacks=this.callbacks.filter(e=>e.id!==t)}unsubscribe(t){this.callbacks=this.callbacks.filter(e=>e.caller!==t)}}const g=new rt;class f{}p(f,"PLAYER_PICK_UP_ITEM","PLAYER_PICK_UP_ITEM"),p(f,"CHANGE_SCENE","CHANGE_SCENE"),p(f,"START_TEXT_BOX","START_TEXT_BOX"),p(f,"END_TEXT_BOX","END_TEXT_BOX"),p(f,"CAMERA_POSITION","CAMERA_POSITION"),p(f,"DO_ACTION_ON_COORDINATE","DO_ACTION_ON_COORDINATE");class T{constructor({position:t}){this.position=t??new d(0,0),this.children=[],this.parent=null,this.hasBeenInitiated=!1,this.isSolid=!1,this.drawLayer=null}stepEntry(t,e){this.children.forEach(s=>s.stepEntry(t,e)),this.hasBeenInitiated||(this.hasBeenInitiated=!0,this.onInit()),this.step(t,e)}onInit(){}step(t){}draw(t,e,s){const n=e+this.position.x,r=s+this.position.y;this.drawImage(t,n,r),this.getDrawChildrenOrdered().forEach(o=>o.draw(t,n,r))}getDrawChildrenOrdered(){return[...this.children].sort((t,e)=>e.drawLayer==="FLOOR"||t.position.y>e.position.y?1:-1)}drawImage(t,e,s){}destroy(){this.children.forEach(t=>t.destroy()),this.parent&&this.parent.removeChild(this)}addChild(t){t.parent=this,this.children.push(t)}removeChild(t){g.unsubscribe(t),this.children=this.children.filter(e=>e!==t)}}class ot extends T{constructor(){super({});p(this,"zoom",1);this.zoom=1,this.offset=new d(0,0),this.onInit()}onInit(){g.on(f.CAMERA_POSITION,this,e=>{e.focus&&this.centerPositionOnTarget(e.position)}),g.on(f.CHANGE_SCENE,this,e=>{this.centerPositionOnTarget(e.heroStartPosition)})}centerPositionOnTarget(e){this.position=new d(-e.x+632,-e.y+632)}}class at{constructor(){this.flags=new Map}add(t){this.flags.set(t,!0)}remove(t){this.flags.delete(t)}getRelevantScenario(t=[]){return t.find(e=>{const s=e.bypass??[];for(let r=0;r<s.length;r++){const o=s[r];if(this.flags.has(o))return!1}const n=e.requires??[];for(let r=0;r<n.length;r++){const o=n[r];if(!this.flags.has(o))return!1}return!0})}}const M=new at;class ct{constructor(){this.toLoad={hero:"sprites/hero-sheet.png",shadow:"sprites/shadow.png",rod:"sprites/rod.png",exit:"sprites/exit.png",sky:"sprites/sky.png",ground:"sprites/ground.png",cave:"sprites/cave.png",caveGround:"sprites/cave-ground.png",knight:"sprites/knight-sheet-1.png",textBox:"sprites/text-box.png",portraits:"sprites/portraits-sheet.png",fontWhite:"sprites/sprite-font-white.png"},this.images={};var t="";try{t="/"+h.baseUrl+"/"+h.assetsPath+"/"}catch(e){console.log(e),t="/"+h.baseUrl+"/"+h.assetsPath+"/"}console.log(`"${t}"`),Object.keys(this.toLoad).forEach(e=>{const s=new Image;s.src=t+this.toLoad[e],this.images[e]={image:s,isLoaded:!1},s.onload=()=>{this.images[e].isLoaded=!0}})}}const O=new ct;class I extends T{constructor({resource:t,frameSize:e,hFrames:s,vFrames:n,frame:r,scale:o,position:c,animations:y}){super({position:c??new d(0,0)}),this.resource=t,this.frameSize=e??new d(h.sizes.gridSize,h.sizes.gridSize),this.hFrames=s??1,this.vFrames=n??1,this.frame=r??0,this.frameMap=new Map,this.scale=o??1,this.position=c??new d(0,0),this.animations=y??null,this.buildFrameMap()}buildFrameMap(){let t=0;for(let e=0;e<this.vFrames;e++)for(let s=0;s<this.hFrames;s++)this.frameMap.set(t,new d(s*this.frameSize.x,e*this.frameSize.y)),t++}step(t){this.animations&&(this.animations.step(t),this.frame=this.animations.frame)}drawImage(t,e,s){if(!this.resource.isLoaded)return;let n=0,r=0;const o=this.frameMap.get(this.frame);o&&(n=o.x,r=o.y);const c=this.frameSize.x,y=this.frameSize.y;t.drawImage(this.resource.image,n,r,c,y,e,s,c*this.scale,y*this.scale)}}class ht extends T{constructor(){super({position:new d(0,1)}),this.items=[],this.drawLayer="HUD",this.nextId=0,this.renderInventory()}renderInventory(){this.children.forEach(t=>t.destroy()),this.items.forEach((t,e)=>{const s=new I({resource:t.image,position:new d(e*12,0)});this.addChild(s)})}removeFromInventory(t){this.items=this.items.filter(e=>e.id!==t),this.renderInventory()}onInit(){g.on(f.PLAYER_PICK_UP_ITEM,this,t=>{this.items.push({id:this.nextId++,image:t.image}),console.log(this.items),this.renderInventory()})}}const lt=5,l=new Map;l.set("i",2);l.set("j",4);l.set("l",3);l.set("r",4);l.set("t",4);l.set("u",4);l.set("v",4);l.set("x",4);l.set("y",4);l.set("z",4);l.set("E",4);l.set("F",4);l.set("M",7);l.set("W",7);l.set(" ",3);l.set("'",2);l.set("!",1);const dt=i=>l.get(i)??lt,G=new Map;["abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ","0123456789 __",".!-,?'"].join("").split("").forEach((i,t)=>{G.set(i,t)});const ut=i=>G.get(i)??null,ft=4,mt=1,pt=3,gt=20,Et=1,wt=1;class yt extends T{constructor(t={}){super({position:new d(32,108)}),this.drawLayer="HUD";const e=t.string??"Default Text";this.words=e.split(" ").map(s=>{let n=0;const r=s.split("").map(o=>{const c=dt(o);return n+=c,{width:c,sprite:new I({resource:O.images.fontWhite,hFrames:13,vFrames:6,frame:ut(o)})}});return{wordWidth:n,chars:r}}),this.backdrop=new I({resource:O.images.textBox,frameSize:new d(256,64)}),t.portraitFrame!==null&&t.portraitFrame!==void 0?this.portrait=new I({resource:O.images.portraits,hFrames:4,vFrames:1,frame:t.portraitFrame??0}):this.portrait=null,this.showingIndex=0,this.finalIndex=this.words.reduce((s,n)=>s+n.chars.length,0),this.textSpeed=gt,this.timeUntilNextShow=this.textSpeed}step(t,e){const s=e.input;if(s!=null&&s.getActionJustPressed("Space")){if(this.showingIndex<this.finalIndex){this.showingIndex=this.finalIndex;return}g.emit(f.END_TEXT_BOX)}this.timeUntilNextShow-=t,this.timeUntilNextShow<=0&&(this.showingIndex+=wt,this.timeUntilNextShow+=this.textSpeed)}drawImage(t,e,s){this.backdrop.drawImage(t,e,s),this.portrait&&this.portrait.drawImage(t,e+6,s+6);const o=7,c=7,y=240,q=14,j=18,$=2;let N=o,b=c;this.portrait&&(N+=j,b+=$);let S=e+N,X=s+b,k=0;this.words.forEach(z=>{e+y-S<z.wordWidth&&(S=e+N,X+=q),z.chars.forEach(J=>{if(k>this.showingIndex)return;const{sprite:Z,width:Q}=J,V=S-ft;Z.draw(t,V,X),S+=Q+mt,k+=Et}),S+=pt})}}class It extends T{constructor(){super({}),this.level=null,this.input=new it,this.camera=new ot}onInit(){const t=new ht;this.addChild(t),g.on(f.CHANGE_SCENE,this,e=>{this.setLevel(e)}),g.on(f.DO_ACTION_ON_COORDINATE,this,e=>{if(typeof e.getContent=="function"){const s=e.getContent();if(!s)return;s.addsFlags&&s.addsFlags.forEach(c=>{M.add(c)}),s.removesFlags&&s.removesFlags.forEach(c=>{M.remove(c)});const n={string:s.string,portraitFrame:s.portraitFrame??null};let r=null;r=new yt(n),this.addChild(r),g.emit(f.START_TEXT_BOX);const o=g.on(f.END_TEXT_BOX,this,()=>{r.destroy(),g.off(o)})}})}setLevel(t){this.level&&this.level.destroy(),this.level=t,this.addChild(this.level)}drawBackground(t){var e;(e=this.level)==null||e.background.drawImage(t,0,0)}drawObjects(t){this.children.forEach(e=>{e.drawLayer!=="HUD"&&e.draw(t,0,0)})}drawForeground(t){this.children.forEach(e=>{e.drawLayer==="HUD"&&e.draw(t,0,0)})}}class Tt extends T{constructor(){super({}),this.background=null,this.walls=new Set}}class _t extends Tt{constructor(t={}){super({}),this.background=new I({resource:O.images.sky,frameSize:new d(h.sizes.canvasWidth,h.sizes.canvasHeight),scale:8});const e=new I({resource:O.images.ground,frameSize:new d(h.sizes.canvasWidth,h.sizes.canvasHeight),scale:4});this.addChild(e)}onInit(){}}const u=document.querySelector("#game-canvas"),E=u.getContext("2d"),a=new It({position:new d(0,0)});a.setLevel(new _t);let m=1;const Y=.05;let _=!1,L=0,P=0,C=0,F=0,w=0,x=!1;const R=.5,v=3,St=i=>{var t;a.stepEntry(i,a),(t=a.input)==null||t.update()},Dt=()=>{E.clearRect(0,0,u.width,u.height),a.drawBackground(E),E.save(),a.camera&&(E.translate(u.width/2,u.height/2),E.scale(m,m),E.translate(-u.width/2+a.camera.position.x,-u.height/2+a.camera.position.y)),a.drawObjects(E,0,0),E.restore(),a.drawForeground(E)},Ot=new nt(St,Dt);Ot.start();const xt=i=>{_=!0,C=i.clientX||i.touches[0].clientX,F=i.clientY||i.touches[0].clientY},At=i=>{if(_){const t=i.clientX||i.touches[0].clientX,e=i.clientY||i.touches[0].clientY,s=(i.touches,1);a.camera.position.x+=(t-C)*s/m,a.camera.position.y+=(e-F)*s/m,C=t,F=e}if(i.touches&&i.touches.length===2){i.preventDefault();const t=i.touches[0],e=i.touches[1],s=Math.hypot(e.clientX-t.clientX,e.clientY-t.clientY);if(w>0){const n=s/w,r=m*n;if(r>=R&&r<=v){m=r;const o=(t.clientX+e.clientX)/2,c=(t.clientY+e.clientY)/2;a.camera.position.x=o-(o-a.camera.position.x)*n,a.camera.position.y=c-(c-a.camera.position.y)*n}else x=!0}w=s}},B=()=>{_=!1,w=0,x=!1},Nt=i=>{i.preventDefault();const t=i.deltaY<0?1+Y:1-Y;m*=t,m=Math.max(R,Math.min(v,m))},Lt=i=>{if(i.touches.length===2){i.preventDefault();const t=i.touches[0],e=i.touches[1];w=Math.hypot(e.clientX-t.clientX,e.clientY-t.clientY)}else i.touches.length===1&&(_=!0,L=i.touches[0].clientX,P=i.touches[0].clientY)},Pt=i=>{if(x){i.preventDefault();return}if(i.touches.length===2){i.preventDefault();const t=i.touches[0],e=i.touches[1],s=Math.hypot(e.clientX-t.clientX,e.clientY-t.clientY);if(w>0){const n=s/w,r=m*n;if(r>=R&&r<=v){m=r;const o=(t.clientX+e.clientX)/2,c=(t.clientY+e.clientY)/2;a.camera.position.x=o-(o-a.camera.position.x)*n,a.camera.position.y=c-(c-a.camera.position.y)*n}else x=!0}w=s}else if(i.touches.length===1&&_){const t=i.touches[0].clientX,e=i.touches[0].clientY;a.camera.position.x+=(t-L)/m,a.camera.position.y+=(e-P)/m,L=t,P=e}},Ct=()=>{_=!1,w=0,x=!1};u.addEventListener("mousedown",xt);u.addEventListener("mousemove",At);u.addEventListener("mouseup",B);u.addEventListener("mouseleave",B);u.addEventListener("wheel",Nt,{passive:!1});u.addEventListener("touchstart",Lt,{passive:!1});u.addEventListener("touchmove",Pt,{passive:!1});u.addEventListener("touchend",Ct);
